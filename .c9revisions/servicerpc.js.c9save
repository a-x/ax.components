{"ts":1359568409924,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"(function(module, $, undefined) {\r\n    \"use strict\";\r\n\r\n    var validate = function(req) {\r\n        var error;\r\n        if (typeof(req.method) !== 'string') {\r\n            error = {\r\n                code: 32600,\r\n                message: 'Invalid Request'\r\n            };\r\n        }\r\n        else if (req.params && typeof(req.params) !== 'object') {\r\n            error = {\r\n                code: 32602,\r\n                message: 'Invalid params'\r\n            };\r\n        }\r\n\r\n        return error;\r\n    };\r\n\r\n    var uuid = function() {\r\n        uuid._salt = uuid._salt || (Math.random()*1000000 | 1);\r\n        uuid._id = +uuid._id || 0;\r\n        return ++uuid._id + '-' + (+new Date) + '-' + uuid._salt;\r\n\r\n    };\r\n    \r\n    var inherits = function(child, parent) {\r\n        var F = function() { };\r\n        F.prototype = parent.prototype;\r\n        child.prototype = new F();\r\n        child.prototype.constructor = child;\r\n        child.superclass = parent.prototype;\r\n        child.parent = parent;\r\n    };\r\n    \r\n    // Transport interface\r\n    var Transport = function (url) {\r\n        this._args = {url: url || '/'};\r\n        this._init();\r\n    };\r\n\r\n    Transport.prototype.send = function(req) {\r\n    };\r\n\r\n    // SockJS transport\r\n    var Sock = function(url) {\r\n        Transport.apply(this, arguments);\r\n    };\r\n\r\n    inherits(Sock, Transport);\r\n    \r\n    Sock.prototype._init = function() {\r\n        var sockjs_url = this._args.url;\r\n        this.sockjs = new SockJS(sockjs_url);\r\n        var self = this;\r\n        this.sockjs.onopen    = function()  {\r\n            self._opened = true;\r\n        };\r\n        this.sockjs.onmessage = function(e) {\r\n            var data = e.data || '',\r\n                error,\r\n                res = {};\r\n            try {\r\n                res = JSON.parse(data);\r\n            } catch (err) {\r\n                error = { code:-32603, message: 'Internal error' };\r\n            }\r\n            res = (typeof(res) === 'object') ? res : {error: error || { code:-32603, message: 'Internal error' }};\r\n              \r\n            self.onmessage && self.onmessage(res);\r\n        };\r\n        this.sockjs.onclose   = function()  {\r\n            self._opened = false;\r\n            self.onerror && self.onerror({error: { code:-32603, message: 'Internal error' }});\r\n            self._init();\r\n        };\r\n        this.sockjs.onerror   = function(e)  {\r\n            self._opened = false;\r\n            self.onerror && self.onerror({error: { code:-32603, message: 'Internal error' }});\r\n        };\r\n    };\r\n    \r\n    Sock.prototype.send = function(req) {\r\n        this.sockjs.send(JSON.stringify(req), this.sockjs.onerror);\r\n    }\r\n    \r\n    // WebSocket transport\r\n    var WSocket= function(url) {\r\n        Transport.apply(this, arguments);\r\n    };\r\n\r\n    inherits(WSocket, Transport);\r\n    \r\n    WSocket.prototype._init = function() {\r\n        this.ws = new WebSocket(this._args.url);\r\n        var self = this;\r\n        this.ws.onopen    = function()  {\r\n            self._opened = true;\r\n        };\r\n        this.ws.onmessage = function(e) {\r\n            var data = e.data || '',\r\n                error,\r\n                res = {};\r\n            try {\r\n                res = JSON.parse(data);\r\n            } catch (err) {\r\n                error = { code:-32603, message: 'Internal error' };\r\n            }\r\n            res = (typeof(res) === 'object') ? res : {error: error || { code:-32603, message: 'Internal error' }};\r\n              \r\n            self.onmessage && self.onmessage(res);\r\n        };\r\n        this.ws.onclose   = function()  {\r\n            self._opened = false;\r\n            self.onerror && self.onerror({error: { code:-32603, message: 'Internal error' }});\r\n            self._init();\r\n        };\r\n        this.ws.onerror   = function(e)  {\r\n            self._opened = false;\r\n            self.onerror && self.onerror({error: { code:-32603, message: 'Internal error' }});\r\n        };\r\n    };\r\n    \r\n    WSocket.prototype.send = function(req) {\r\n        this.ws.send(JSON.stringify(req), this.ws.onerror);\r\n    }\r\n\r\n    // HttpGet transport\r\n    var HttpGet= function(url) {\r\n        Transport.apply(this, arguments);\r\n    };\r\n\r\n    inherits(HttpGet, Transport);\r\n    \r\n    HttpGet.prototype._init = function() {\r\n        var self = this;\r\n        this._onmessage = function(res) {\r\n            self.onmessage && self.onmessage(res);\r\n        };\r\n        this._onerror = function(res) {\r\n            self.onerror && self.onerror({error: { code:-32603, message: 'Internal error' }});\r\n        };\r\n    };\r\n    \r\n    HttpGet.prototype.send = function(req) {\r\n        $.getJSON(this._args.url, req)\r\n            .success(this._onmessage)\r\n            .error(this._onerror);\r\n    }\r\n    \r\n    // HttpPost transport\r\n    var HttpPost= function(url) {\r\n        HttpGet.apply(this, arguments);\r\n    };\r\n\r\n    inherits(HttpPost, HttpGet);\r\n\r\n    HttpPost.prototype.send = function(req) {\r\n        $.ajax({\r\n            dataType: \"json\",\r\n            url: this._args.url,\r\n            data: req,\r\n            type: \"POST\"\r\n        })\r\n        .success(this._onmessage)\r\n        .error(this._onerror);\r\n    }\r\n\r\n    // Service\r\n    var Service = module.Service = function(url, args) {\r\n        this._args = args || {};\r\n        this._url = url || '';\r\n        this._methods = {};\r\n        this._callbacks = {};\r\n        this._clearCallbacks();\r\n        switch (this._args.transport) {\r\n            case 'SockJS' : \r\n                this._transport =  new Sock(this._url);\r\n                break;\r\n            case 'WebSocket' : \r\n                this._transport =  new WSocket(this._url);\r\n                break;\r\n            case 'HttpPost' : \r\n                this._transport =  new HttpPost(this._url);\r\n                break;\r\n            case 'HttpGet' : \r\n            default:\r\n                this._transport =  new HttpGet(this._url);\r\n        }\r\n        \r\n        var self = this;\r\n        this._transport.onmessage = function(res) {\r\n            res = typeof(res) === 'object' ? res : {error: { code:-32603, message: 'Internal error' }};\r\n            var callback = res.id && self._callbacks[res.id];\r\n            res.id && (delete self._callbacks[res.id]);\r\n            callback && callback(res.error, res.result);\r\n        };\r\n        this._transport.onerror = function(res) {\r\n            self._clearCallbacks();\r\n        };\r\n        \r\n        return this.bind();\r\n    }\r\n\r\n    Service.prototype._clearCallbacks = function() {\r\n        for(var id in this.callbacks) {\r\n            if (!this._callbacks.hasOwnProperty(id))\r\n                continue;\r\n            var callback = this._callbacks[id];\r\n            if (typeof(callback) === 'function') {\r\n                callback({ code:-32603, message: 'Internal error' });\r\n            }\r\n        }\r\n        this._callbacks = {}\r\n    }\r\n\r\n    Service.prototype._call = function(req, callback) {\r\n        var err = validate(req);\r\n        if (err) {\r\n            callback && callback(err);\r\n        } \r\n        else {\r\n            callback ? (req.id = uuid()) : (delete(req.id));\r\n            callback && (this._callbacks[req.id] = callback);\r\n            req.jsonrpc = '2.0';\r\n            this._transport.send(req);\r\n        }\r\n    }\r\n\r\n    Service.prototype.bind = function() {\r\n        var self = this;\r\n        return function() {\r\n            return self.method.apply(self, arguments);\r\n        };\r\n    }\r\n    \r\n    Service.prototype.method = function(name) {\r\n        name = name || '';\r\n        var self = this;\r\n        \r\n        this._methods.hasOwnProperty(name) || (this._methods[name] = function () {\r\n            var args = Array.prototype.slice.call(arguments),\r\n                callback = args[args.length-1];\r\n            if (typeof(callback) === 'function') {\r\n                args.length = args.length-1;\r\n            } else {\r\n                callback = undefined;\r\n            }\r\n            var req = {method: name};\r\n            args && (req.params = args);\r\n            self._call(req, callback);            \r\n        });\r\n        return this._methods[name];\r\n    }\r\n    \r\n})( typeof(module) !== 'undefined' && module.exports ? module : this, jQuery );\r\n/**   MODULE  **/"]],"start1":0,"start2":0,"length1":0,"length2":8186}]],"length":8186}
